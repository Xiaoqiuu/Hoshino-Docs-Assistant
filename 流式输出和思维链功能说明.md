# æµå¼è¾“å‡ºå’Œæ€ç»´é“¾åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°æ·»åŠ äº†ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼š

### 1. æµå¼è¾“å‡ºï¼ˆStream Outputï¼‰
AI å›å¤å°†ä»¥æ‰“å­—æœºæ•ˆæœé€å­—æ˜¾ç¤ºï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

### 2. æ€ç»´é“¾æ˜¾ç¤ºï¼ˆReasoning Contentï¼‰
å¯¹äºæ¨ç†æ¨¡å‹ï¼ˆå¦‚ DeepSeek Reasonerã€DeepSeek-R1ï¼‰ï¼Œå¯ä»¥å±•ç¤º AI çš„æ€è€ƒè¿‡ç¨‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æµå¼è¾“å‡º
- âœ… å®æ—¶æ˜¾ç¤º AI å›å¤å†…å®¹
- âœ… æ‰“å­—æœºæ•ˆæœï¼Œæ›´è‡ªç„¶çš„äº¤äº’ä½“éªŒ
- âœ… å¯åœ¨è®¾ç½®ä¸­å¼€å…³
- âœ… æ”¯æŒä¸­æ–­å’Œé”™è¯¯å¤„ç†
- âœ… å…¼å®¹éæµå¼æ¨¡å¼

### æ€ç»´é“¾æ˜¾ç¤º
- âœ… å±•ç¤ºæ¨ç†æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹
- âœ… å¯æŠ˜å /å±•å¼€çš„æ€ç»´é“¾é¢æ¿
- âœ… ç‹¬ç«‹äºä¸»è¦å›å¤å†…å®¹
- âœ… æ”¯æŒ Markdown æ ¼å¼
- âœ… å¯åœ¨è®¾ç½®ä¸­å¼€å…³
- âœ… ä»…åœ¨ä½¿ç”¨æ¨ç†æ¨¡å‹æ—¶æ˜¾ç¤º

## ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨æµå¼è¾“å‡º

1. ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½®æŒ‰é’®
2. åœ¨"è¾“å‡ºè®¾ç½®"éƒ¨åˆ†æ‰¾åˆ°"å¯ç”¨æµå¼è¾“å‡º"
3. å‹¾é€‰è¯¥é€‰é¡¹
4. ç‚¹å‡»"ä¿å­˜"

### 2. å¯ç”¨æ€ç»´é“¾æ˜¾ç¤º

1. ç¡®ä¿ä½¿ç”¨æ¨ç†æ¨¡å‹ï¼š
   - äº‘ç«¯æ¨¡å¼ï¼šé€‰æ‹© `deepseek-reasoner`
   - æœ¬åœ°æ¨¡å¼ï¼šä½¿ç”¨åŒ…å« `reasoner` æˆ– `r1` çš„æ¨¡å‹ï¼ˆå¦‚ `deepseek-r1:7b`ï¼‰
2. åœ¨è®¾ç½®ä¸­å‹¾é€‰"æ˜¾ç¤ºæ€ç»´é“¾å†…å®¹"
3. ç‚¹å‡»"ä¿å­˜"

### 3. æŸ¥çœ‹æ€ç»´é“¾

å½“ AI å›å¤æ—¶ï¼Œå¦‚æœæœ‰æ€ç»´é“¾å†…å®¹ï¼Œä¼šåœ¨å›å¤ä¸Šæ–¹æ˜¾ç¤ºä¸€ä¸ªå¯æŠ˜å çš„é¢æ¿ï¼š

```
ğŸ§  æ€ç»´è¿‡ç¨‹ â–¶
```

ç‚¹å‡»å³å¯å±•å¼€æŸ¥çœ‹ AI çš„æ€è€ƒè¿‡ç¨‹ã€‚

## æŠ€æœ¯å®ç°

### æµå¼è¾“å‡ºå®ç°

#### åç«¯ï¼ˆä¸»è¿›ç¨‹ï¼‰

```typescript
// aiService.ts - æµå¼èŠå¤©æ–¹æ³•
async *chatStream(message: string): AsyncGenerator<{
  content?: string;
  reasoningContent?: string;
  done: boolean;
  error?: string;
}> {
  const stream = await this.client!.chat.completions.create({
    model: modelToUse,
    messages: [...],
    stream: true, // å¯ç”¨æµå¼
  });

  for await (const chunk of stream) {
    const delta = chunk.choices[0]?.delta;
    
    // å¤„ç†æ€ç»´é“¾å†…å®¹
    if (delta.reasoning_content) {
      yield { reasoningContent: delta.reasoning_content, done: false };
    }
    
    // å¤„ç†å¸¸è§„å†…å®¹
    if (delta.content) {
      yield { content: delta.content, done: false };
    }
  }
}
```

#### IPC é€šä¿¡

```typescript
// main.ts - æµå¼æ¶ˆæ¯å¤„ç†å™¨
ipcMain.handle('send-message-stream', async (event, message, selectedText) => {
  for await (const chunk of aiService.chatStream(message)) {
    // é€šè¿‡äº‹ä»¶å‘é€æµå¼æ•°æ®å—
    event.sender.send('message-stream-chunk', {
      type: chunk.reasoningContent ? 'reasoning' : 'content',
      content: chunk.content || chunk.reasoningContent,
      done: chunk.done,
    });
  }
});
```

#### å‰ç«¯ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰

```typescript
// App.tsx - æµå¼æ¥æ”¶å’Œæ˜¾ç¤º
let streamContent = '';
let streamReasoningContent = '';

const handleStreamChunk = (data) => {
  if (data.type === 'content') {
    streamContent += data.content;
    // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
    setMessages(prev => {
      const newMessages = [...prev];
      newMessages[lastIndex] = {
        content: streamContent,
        reasoningContent: streamReasoningContent,
      };
      return newMessages;
    });
  }
};

window.electronAPI.onMessageStreamChunk(handleStreamChunk);
```

### æ€ç»´é“¾æ˜¾ç¤ºå®ç°

#### æ•°æ®ç»“æ„

```typescript
interface AIResponse {
  response: string;
  sources?: Source[];
  reasoningContent?: string; // æ€ç»´é“¾å†…å®¹
}

interface Message {
  role: 'user' | 'assistant';
  content: string;
  reasoningContent?: string; // æ€ç»´é“¾å†…å®¹
}
```

#### UI ç»„ä»¶

```tsx
{msg.reasoningContent && (
  <details className="reasoning-content">
    <summary>ğŸ§  æ€ç»´è¿‡ç¨‹</summary>
    <div className="reasoning-text">
      <ReactMarkdown>{msg.reasoningContent}</ReactMarkdown>
    </div>
  </details>
)}
```

## é…ç½®é€‰é¡¹

### AppConfig æ¥å£

```typescript
interface AppConfig {
  // ... å…¶ä»–é…ç½®
  streamOutput?: boolean; // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡ºï¼ˆé»˜è®¤ï¼štrueï¼‰
  showReasoningContent?: boolean; // æ˜¯å¦æ˜¾ç¤ºæ€ç»´é“¾ï¼ˆé»˜è®¤ï¼štrueï¼‰
}
```

### é»˜è®¤é…ç½®

```typescript
{
  streamOutput: true,
  showReasoningContent: true
}
```

## API å‚è€ƒ

### ä¸»è¿›ç¨‹ API

#### aiService.chatStream()
```typescript
async *chatStream(message: string): AsyncGenerator<{
  content?: string;
  reasoningContent?: string;
  done: boolean;
  error?: string;
}>
```

æµå¼èŠå¤©æ–¹æ³•ï¼Œè¿”å›å¼‚æ­¥ç”Ÿæˆå™¨ã€‚

**å‚æ•°ï¼š**
- `message`: ç”¨æˆ·æ¶ˆæ¯

**è¿”å›ï¼š**
- å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œæ¯æ¬¡ yield ä¸€ä¸ªæ•°æ®å—

### IPC API

#### send-message-stream
```typescript
ipcRenderer.invoke('send-message-stream', message, selectedText)
```

å‘é€æµå¼æ¶ˆæ¯è¯·æ±‚ã€‚

**äº‹ä»¶ï¼š**
- `message-stream-chunk`: æ¥æ”¶æµå¼æ•°æ®å—

### å‰ç«¯ API

#### window.electronAPI.sendMessageStream()
```typescript
sendMessageStream(message: string, selectedText?: string): Promise<AIResponse>
```

å‘é€æµå¼æ¶ˆæ¯ã€‚

#### window.electronAPI.onMessageStreamChunk()
```typescript
onMessageStreamChunk(callback: (data: {
  type: string;
  content?: string;
  done: boolean;
}) => void): void
```

ç›‘å¬æµå¼æ•°æ®å—ã€‚

**æ•°æ®ç±»å‹ï¼š**
- `type: 'content'` - ä¸»è¦å›å¤å†…å®¹
- `type: 'reasoning'` - æ€ç»´é“¾å†…å®¹
- `type: 'error'` - é”™è¯¯ä¿¡æ¯
- `type: 'done'` - å®Œæˆæ ‡å¿—

## æ”¯æŒçš„æ¨¡å‹

### æ¨ç†æ¨¡å‹ï¼ˆæ”¯æŒæ€ç»´é“¾ï¼‰

#### äº‘ç«¯æ¨¡å‹
- `deepseek-reasoner` - DeepSeek æ¨ç†æ¨¡å‹

#### æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰
- `deepseek-r1:7b` - DeepSeek R1 7B
- `deepseek-r1:14b` - DeepSeek R1 14B
- `deepseek-r1:32b` - DeepSeek R1 32B
- å…¶ä»–åŒ…å« `reasoner` æˆ– `r1` çš„æ¨¡å‹

### æ™®é€šæ¨¡å‹ï¼ˆä¸æ”¯æŒæ€ç»´é“¾ï¼‰
- `deepseek-chat` - DeepSeek Chat
- `qwen2.5:7b` - Qwen 2.5
- `llama3.2:3b` - Llama 3.2
- å…¶ä»–æ ‡å‡†å¯¹è¯æ¨¡å‹

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä½¿ç”¨æµå¼è¾“å‡º

```typescript
// ç”¨æˆ·å‘é€æ¶ˆæ¯
const response = await window.electronAPI.sendMessageStream(
  "è§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—çš„åŸç†",
  undefined
);

// å®æ—¶æ¥æ”¶æµå¼å†…å®¹
window.electronAPI.onMessageStreamChunk((data) => {
  if (data.type === 'content') {
    console.log('æ”¶åˆ°å†…å®¹:', data.content);
  }
  if (data.done) {
    console.log('æµå¼ä¼ è¾“å®Œæˆ');
  }
});
```

### ç¤ºä¾‹ 2ï¼šæŸ¥çœ‹æ€ç»´é“¾

1. åœ¨è®¾ç½®ä¸­é€‰æ‹© `deepseek-reasoner` æ¨¡å‹
2. å¯ç”¨"æ˜¾ç¤ºæ€ç»´é“¾å†…å®¹"
3. å‘é€ä¸€ä¸ªéœ€è¦æ¨ç†çš„é—®é¢˜ï¼š
   ```
   9.11 å’Œ 9.8 å“ªä¸ªæ›´å¤§ï¼Ÿ
   ```
4. AI ä¼šå…ˆå±•ç¤ºæ€ç»´è¿‡ç¨‹ï¼Œç„¶åç»™å‡ºç­”æ¡ˆ

### ç¤ºä¾‹ 3ï¼šPython é£æ ¼çš„æµå¼å¤„ç†

å‚è€ƒ DeepSeek API æ–‡æ¡£çš„ Python ç¤ºä¾‹ï¼š

```python
from openai import OpenAI

client = OpenAI(
    api_key="<DeepSeek API Key>",
    base_url="https://api.deepseek.com"
)

messages = [{"role": "user", "content": "9.11 and 9.8, which is greater?"}]

response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=messages,
    stream=True
)

reasoning_content = ""
content = ""

for chunk in response:
    if chunk.choices[0].delta.reasoning_content:
        reasoning_content += chunk.choices[0].delta.reasoning_content
    else:
        content += chunk.choices[0].delta.content
```

æœ¬åº”ç”¨çš„å®ç°ä¸æ­¤ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ TypeScript å’Œ Electron IPCã€‚

## æ³¨æ„äº‹é¡¹

### æµå¼è¾“å‡º
1. **æ€§èƒ½**ï¼šæµå¼è¾“å‡ºä¼šå¢åŠ  IPC é€šä¿¡é¢‘ç‡ï¼Œä½†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
2. **å…¼å®¹æ€§**ï¼šå¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å…³é—­æµå¼è¾“å‡ºå›é€€åˆ°æ™®é€šæ¨¡å¼
3. **RAG æ¨¡å¼**ï¼šå½“å‰ RAG æ¨¡å¼æš‚ä¸æ”¯æŒæµå¼è¾“å‡º

### æ€ç»´é“¾
1. **æ¨¡å‹æ”¯æŒ**ï¼šåªæœ‰æ¨ç†æ¨¡å‹æ‰æœ‰æ€ç»´é“¾å†…å®¹
2. **å†…å®¹é•¿åº¦**ï¼šæ€ç»´é“¾å¯èƒ½å¾ˆé•¿ï¼Œå·²æ·»åŠ æ»šåŠ¨å’ŒæŠ˜å åŠŸèƒ½
3. **æ€§èƒ½å½±å“**ï¼šæ€ç»´é“¾ä¼šå¢åŠ  token æ¶ˆè€—å’Œå“åº”æ—¶é—´

## æ•…éšœæ’é™¤

### æµå¼è¾“å‡ºä¸å·¥ä½œ

**é—®é¢˜ï¼š** æ¶ˆæ¯ä¸æ˜¯é€å­—æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥è®¾ç½®ä¸­æ˜¯å¦å¯ç”¨äº†"æµå¼è¾“å‡º"
2. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
3. å°è¯•é‡å¯åº”ç”¨
4. å¦‚æœé—®é¢˜æŒç»­ï¼Œå…³é—­æµå¼è¾“å‡ºä½¿ç”¨æ™®é€šæ¨¡å¼

### æ€ç»´é“¾ä¸æ˜¾ç¤º

**é—®é¢˜ï¼š** ä½¿ç”¨æ¨ç†æ¨¡å‹ä½†çœ‹ä¸åˆ°æ€ç»´é“¾

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤ä½¿ç”¨çš„æ˜¯æ¨ç†æ¨¡å‹ï¼ˆdeepseek-reasoner æˆ– deepseek-r1ï¼‰
2. æ£€æŸ¥è®¾ç½®ä¸­æ˜¯å¦å¯ç”¨äº†"æ˜¾ç¤ºæ€ç»´é“¾å†…å®¹"
3. æŸäº›ç®€å•é—®é¢˜å¯èƒ½ä¸ä¼šè§¦å‘æ€ç»´é“¾
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤æ˜¯å¦æ”¶åˆ° reasoning_content

### API é”™è¯¯

**é—®é¢˜ï¼š** æµå¼è¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ
2. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
3. æŸ¥çœ‹ API é…é¢æ˜¯å¦å……è¶³
4. å°è¯•ä½¿ç”¨éæµå¼æ¨¡å¼æµ‹è¯•

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-XX)
- âœ… æ·»åŠ æµå¼è¾“å‡ºåŠŸèƒ½
- âœ… æ·»åŠ æ€ç»´é“¾æ˜¾ç¤ºåŠŸèƒ½
- âœ… åœ¨è®¾ç½®ä¸­æ·»åŠ å¼€å…³é€‰é¡¹
- âœ… ä¼˜åŒ– UI æ˜¾ç¤ºæ•ˆæœ
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

## æœªæ¥è®¡åˆ’

- [ ] RAG æ¨¡å¼æ”¯æŒæµå¼è¾“å‡º
- [ ] æ€ç»´é“¾å†…å®¹çš„è¯­æ³•é«˜äº®
- [ ] æ€ç»´é“¾å†…å®¹çš„å¯¼å‡ºåŠŸèƒ½
- [ ] æµå¼è¾“å‡ºçš„æš‚åœ/ç»§ç»­åŠŸèƒ½
- [ ] æ›´å¤šæ¨ç†æ¨¡å‹çš„æ”¯æŒ
- [ ] æ€ç»´é“¾çš„å¯è§†åŒ–å±•ç¤º

## å‚è€ƒèµ„æ–™

- [DeepSeek API æ–‡æ¡£](https://platform.deepseek.com/docs)
- [OpenAI Streaming API](https://platform.openai.com/docs/api-reference/streaming)
- [Electron IPC é€šä¿¡](https://www.electronjs.org/docs/latest/tutorial/ipc)
