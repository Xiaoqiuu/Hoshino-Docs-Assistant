# 思维链交互优化

## 优化内容

### 1. 分离存储
- ✅ 思维过程（reasoning）和正式回复（content）分开存储
- ✅ 每个消息独立管理自己的思维链状态
- ✅ 不会混淆或覆盖

### 2. 智能状态管理
- ✅ 收到正式回复后自动隐藏"思考中"状态
- ✅ 思考阶段显示"思考中..."指示器
- ✅ 正式回复阶段不再显示思考状态

### 3. 自动展开/折叠
- ✅ **思考阶段**：自动展开思维链面板，实时显示思考过程
- ✅ **回复阶段**：收到第一个正式回复字符时，自动折叠思维链
- ✅ 用户可以手动展开/折叠查看完整思维过程

## 交互流程

### 推理模型的完整流程

```
1. 用户发送问题
   ↓
2. 显示空消息框 + "正在思考..."
   ↓
3. 收到思维链内容
   ├─ 自动展开思维链面板
   ├─ 显示 "🧠 思维过程 (思考中...)"
   └─ 实时更新思考内容
   ↓
4. 收到第一个正式回复字符
   ├─ 隐藏 "(思考中...)" 指示器
   ├─ 自动折叠思维链面板
   └─ 开始显示正式回复
   ↓
5. 继续接收正式回复
   └─ 逐字显示（流式输出）
   ↓
6. 完成
   └─ 用户可以点击展开查看完整思维过程
```

## 技术实现

### 状态字段

```typescript
interface Message {
  role: 'user' | 'assistant';
  content: string; // 正式回复内容
  reasoningContent?: string; // 思维链内容（分开存储）
  isThinking?: boolean; // 是否正在思考
  reasoningExpanded?: boolean; // 思维链是否展开
}
```

### 流式处理逻辑

```typescript
// 初始状态
{
  content: '',
  reasoningContent: '',
  isThinking: true,
  reasoningExpanded: true // 思考阶段自动展开
}

// 收到思维链
if (data.type === 'reasoning') {
  reasoningContent += data.content;
  isThinking: true; // 仍在思考
  reasoningExpanded: true; // 保持展开
}

// 收到第一个正式回复
if (data.type === 'content' && !hasReceivedContent) {
  hasReceivedContent = true;
  isThinking: false; // 不再思考
  reasoningExpanded: false; // 自动折叠
}

// 继续接收正式回复
if (data.type === 'content') {
  content += data.content;
  // 保持折叠状态
}
```

### UI 组件

```tsx
{/* 思维链面板 */}
{msg.reasoningContent && (
  <details 
    className="reasoning-content" 
    open={msg.reasoningExpanded} // 受控展开状态
  >
    <summary>
      🧠 思维过程
      {msg.isThinking && (
        <span className="thinking-indicator"> (思考中...)</span>
      )}
    </summary>
    <div className="reasoning-text">
      <ReactMarkdown>{msg.reasoningContent}</ReactMarkdown>
    </div>
  </details>
)}

{/* 思考占位符（还没有任何内容时） */}
{msg.isThinking && !msg.content && !msg.reasoningContent && (
  <div className="thinking-placeholder">
    <div className="dots-loading"></div>
    <span>正在思考...</span>
  </div>
)}

{/* 正式回复内容 */}
{msg.content && (
  <ReactMarkdown>{msg.content}</ReactMarkdown>
)}
```

## 样式优化

### 思考指示器动画

```css
.thinking-indicator {
  color: #6c757d;
  font-size: 13px;
  font-weight: normal;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
```

### 思考占位符

```css
.thinking-placeholder {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  color: #6c757d;
  font-size: 14px;
}
```

## 使用示例

### 示例 1：简单推理问题

**用户输入：**
```
9.11 和 9.8 哪个更大？
```

**交互过程：**
1. 显示 "正在思考..."
2. 展开思维链面板，显示：
   ```
   🧠 思维过程 (思考中...)
   ▼
   首先，我需要比较这两个数字...
   9.11 的整数部分是 9...
   9.8 的整数部分也是 9...
   需要比较小数部分...
   ```
3. 收到正式回复，自动折叠思维链：
   ```
   🧠 思维过程 ▶
   
   9.8 更大。因为...
   ```

### 示例 2：复杂推理问题

**用户输入：**
```
单词 'strawberry' 中有多少个字母 'r'？
```

**交互过程：**
1. 展开思维链，实时显示思考：
   ```
   🧠 思维过程 (思考中...)
   ▼
   让我逐个字母检查...
   s-t-r-a-w-b-e-r-r-y
   第3个字母是 r
   第8个字母是 r
   第9个字母是 r
   ```
2. 自动折叠，显示答案：
   ```
   🧠 思维过程 ▶
   
   单词 'strawberry' 中有 3 个字母 'r'。
   ```

## 配置选项

### 显示思维链
- 位置：设置 → 输出设置 → 显示思维链内容
- 默认：启用
- 效果：
  - 启用：显示思维链面板
  - 禁用：不显示思维链，只显示最终答案

### 流式输出
- 位置：设置 → 输出设置 → 启用流式输出
- 默认：启用
- 效果：
  - 启用：逐字显示，支持思维链实时更新
  - 禁用：一次性显示完整内容

## 对比：优化前 vs 优化后

### 优化前的问题

❌ 思维链和正式回复混在一起
❌ 收到正式回复后仍显示"思考中"
❌ 思维链始终展开或始终折叠
❌ 用户体验不够流畅

### 优化后的改进

✅ 思维链和正式回复分开存储
✅ 智能状态管理，准确显示当前阶段
✅ 自动展开/折叠，符合用户预期
✅ 流畅的交互体验

## 注意事项

1. **仅推理模型支持**
   - 思维链功能仅在推理模型（deepseek-reasoner、deepseek-r1）下可用
   - 普通模型不会显示思维链面板

2. **自动展开/折叠**
   - 思考阶段自动展开，方便查看思考过程
   - 回复阶段自动折叠，避免干扰阅读
   - 用户可以随时手动展开/折叠

3. **性能考虑**
   - 思维链内容可能很长，已添加滚动功能
   - 流式更新频率较高，但不会影响性能

## 故障排除

### Q: 思维链没有自动展开

**A:** 检查：
- 是否使用推理模型
- 是否启用了"显示思维链内容"
- 是否启用了"流式输出"

### Q: 思维链没有自动折叠

**A:** 这是正常的，如果：
- 模型只有思维链，没有正式回复
- 问题太简单，直接给出答案

### Q: 显示"思考中..."但没有内容

**A:** 可能原因：
- 网络延迟
- 模型正在处理
- 等待几秒钟即可

## 更新日志

### v1.1.0
- ✅ 分离思维链和正式回复的存储
- ✅ 添加智能状态管理
- ✅ 实现自动展开/折叠
- ✅ 优化交互体验
- ✅ 添加思考指示器动画

## 未来计划

- [ ] 思维链内容的导出功能
- [ ] 思维链的可视化展示
- [ ] 思维链的搜索和高亮
- [ ] 多轮对话中的思维链关联
