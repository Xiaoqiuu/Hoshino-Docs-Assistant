# 多轮对话和余额查询功能

## 🎉 新功能

### 1. API 余额查询
- 在设置中查询 DeepSeek API 账户余额
- 显示总余额、赠金余额、充值余额
- 支持多币种显示（CNY/USD）

### 2. 真正的多轮对话
- 自动保持对话上下文
- 支持连续提问和追问
- 符合 DeepSeek API 多轮对话规范

## 功能详情

### API 余额查询

#### 使用方法
1. 打开设置（⚙️）
2. 确保已配置 API Key
3. 点击"查询余额"按钮
4. 查看余额信息

#### 显示内容
- **状态**：账户是否可用
- **货币**：CNY（人民币）或 USD（美元）
- **总余额**：包括赠金和充值的总额
- **赠金余额**：未过期的赠金
- **充值余额**：实际充值的金额

#### 示例显示
```
💰 账户余额
状态：✅ 可用

货币：CNY
总余额：100.00
赠金余额：50.00
充值余额：50.00
```

### 多轮对话

#### 工作原理
应用会自动将当前会话的所有历史消息传递给 API，实现真正的上下文理解。

#### 消息格式
```typescript
[
  { role: 'user', content: '第一个问题' },
  { role: 'assistant', content: '第一个回答' },
  { role: 'user', content: '追问' },
  { role: 'assistant', content: '基于上下文的回答' }
]
```

#### 使用示例

**第一轮对话：**
```
用户：世界上最高的山是什么？
AI：世界上最高的山是珠穆朗玛峰（Mount Everest）。
```

**第二轮对话（追问）：**
```
用户：第二高的呢？
AI：第二高的山是乔戈里峰（K2）。
```

AI 能够理解"第二高的"是指山峰，因为它记住了之前的对话。

## 技术实现

### 余额查询 API

#### 后端实现
```typescript
async checkBalance(): Promise<{
  success: boolean;
  balance?: {
    is_available: boolean;
    balance_infos: Array<{
      currency: string;
      total_balance: string;
      granted_balance: string;
      topped_up_balance: string;
    }>;
  };
  message?: string;
}> {
  const response = await fetch(`${this.baseURL}/user/balance`, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'Authorization': `Bearer ${this.apiKey}`,
    },
  });
  
  return await response.json();
}
```

#### API 端点
```
GET https://api.deepseek.com/user/balance
Authorization: Bearer <API_KEY>
```

### 多轮对话实现

#### 消息历史构建
```typescript
// 在 App.tsx 中
const messageHistory = messages
  .filter(msg => msg.role === 'user' || msg.role === 'assistant')
  .map(msg => ({
    role: msg.role,
    content: msg.content
  }));
```

#### AI 服务调用
```typescript
// 在 aiService.ts 中
async chat(message: string, messageHistory?: Array<{ role: string; content: string }>) {
  const messages = [
    { role: 'system', content: '系统提示' },
    ...messageHistory, // 添加历史消息
    { role: 'user', content: message } // 添加当前消息
  ];
  
  const completion = await this.client.chat.completions.create({
    model: modelToUse,
    messages: messages,
  });
}
```

#### 流式输出支持
```typescript
async *chatStream(message: string, messageHistory?: Array<{ role: string; content: string }>) {
  const messages = [
    { role: 'system', content: '系统提示' },
    ...messageHistory,
    { role: 'user', content: message }
  ];
  
  const stream = await this.client.chat.completions.create({
    model: modelToUse,
    messages: messages,
    stream: true,
  });
}
```

## 使用场景

### 余额查询场景

#### 场景 1：检查余额
```
1. 打开设置
2. 点击"查询余额"
3. 查看剩余额度
4. 决定是否需要充值
```

#### 场景 2：验证 API Key
```
1. 输入新的 API Key
2. 点击"查询余额"
3. 如果成功，说明 API Key 有效
4. 如果失败，检查 API Key 是否正确
```

### 多轮对话场景

#### 场景 1：连续提问
```
用户：Python 中如何读取文件？
AI：[解释文件读取方法]

用户：那写入文件呢？
AI：[基于上下文，解释文件写入方法]

用户：有没有更简单的方法？
AI：[基于前面的讨论，提供更简单的方案]
```

#### 场景 2：深入讨论
```
用户：解释一下量子计算
AI：[基础解释]

用户：量子比特是什么？
AI：[详细解释量子比特]

用户：它和经典比特有什么区别？
AI：[对比说明，基于前面的解释]
```

#### 场景 3：代码调试
```
用户：这段代码有什么问题？[贴代码]
AI：[指出问题]

用户：怎么修复？
AI：[提供修复方案，基于之前看到的代码]

用户：还有其他优化建议吗？
AI：[基于代码和修复方案，提供优化建议]
```

## 注意事项

### 余额查询

1. **仅云端模式**
   - 本地模式（Ollama）不支持余额查询
   - 需要配置有效的 DeepSeek API Key

2. **网络要求**
   - 需要网络连接
   - 确保能访问 api.deepseek.com

3. **API Key 权限**
   - 确保 API Key 有查询余额的权限
   - 某些受限 Key 可能无法查询

### 多轮对话

1. **上下文长度**
   - 历史消息会占用 token
   - 对话越长，消耗的 token 越多
   - 建议定期开启新对话

2. **新对话**
   - 点击"新对话"会清空历史
   - 切换会话会加载该会话的历史
   - 每个会话独立维护上下文

3. **RAG 模式**
   - RAG 模式（选中文本问答）不使用历史消息
   - 因为上下文已经是选中的文本

4. **性能影响**
   - 长对话会增加 API 响应时间
   - 建议控制单个会话的消息数量

## 对比：优化前 vs 优化后

### 余额查询

**优化前：**
- ❌ 无法查询余额
- ❌ 不知道剩余额度
- ❌ 需要登录网页查看

**优化后：**
- ✅ 一键查询余额
- ✅ 实时显示额度
- ✅ 无需离开应用

### 多轮对话

**优化前：**
- ❌ 每次都是新对话
- ❌ AI 不记得之前说过什么
- ❌ 需要重复提供上下文

**优化后：**
- ✅ 自动保持上下文
- ✅ AI 记住对话历史
- ✅ 支持连续追问

## API 参考

### 余额查询

#### electronAPI.checkBalance()
```typescript
checkBalance(): Promise<{
  success: boolean;
  balance?: {
    is_available: boolean;
    balance_infos: Array<{
      currency: string;
      total_balance: string;
      granted_balance: string;
      topped_up_balance: string;
    }>;
  };
  message?: string;
}>
```

**返回值：**
- `success`: 是否成功
- `balance`: 余额信息
  - `is_available`: 账户是否可用
  - `balance_infos`: 余额详情数组
    - `currency`: 货币类型（CNY/USD）
    - `total_balance`: 总余额
    - `granted_balance`: 赠金余额
    - `topped_up_balance`: 充值余额
- `message`: 错误信息（失败时）

### 多轮对话

#### electronAPI.sendMessage()
```typescript
sendMessage(
  message: string,
  selectedText?: string,
  messageHistory?: Array<{ role: string; content: string }>
): Promise<AIResponse>
```

**参数：**
- `message`: 当前消息
- `selectedText`: 选中的文本（RAG 模式）
- `messageHistory`: 消息历史（多轮对话）

#### electronAPI.sendMessageStream()
```typescript
sendMessageStream(
  message: string,
  selectedText?: string,
  messageHistory?: Array<{ role: string; content: string }>
): Promise<AIResponse>
```

**参数：**同上

## 测试建议

### 测试余额查询

1. **正常查询**
   ```
   1. 配置有效的 API Key
   2. 点击"查询余额"
   3. 应该显示余额信息
   ```

2. **无效 API Key**
   ```
   1. 输入无效的 API Key
   2. 点击"查询余额"
   3. 应该显示错误信息
   ```

3. **本地模式**
   ```
   1. 切换到本地模式
   2. "查询余额"按钮应该隐藏
   ```

### 测试多轮对话

1. **基础追问**
   ```
   第1轮：世界上最高的山是什么？
   第2轮：第二高的呢？
   第3轮：它们的高度分别是多少？
   ```

2. **代码讨论**
   ```
   第1轮：写一个 Python 函数计算斐波那契数列
   第2轮：能优化一下性能吗？
   第3轮：加上缓存怎么做？
   ```

3. **新对话测试**
   ```
   1. 进行几轮对话
   2. 点击"新对话"
   3. 发送新消息
   4. AI 不应该记得之前的内容
   ```

## 故障排除

### 余额查询失败

**问题：** 点击"查询余额"后显示错误

**解决方案：**
1. 检查 API Key 是否正确
2. 检查网络连接
3. 确认 Base URL 正确（https://api.deepseek.com）
4. 查看控制台错误信息

### 多轮对话不工作

**问题：** AI 不记得之前的对话

**解决方案：**
1. 确认在同一个会话中
2. 检查是否点击了"新对话"
3. 查看控制台是否有错误
4. 确认不是在 RAG 模式下

### Token 消耗过快

**问题：** 余额消耗很快

**解决方案：**
1. 定期开启新对话，清空历史
2. 避免过长的对话
3. 使用更便宜的模型
4. 减少单次消息的长度

## 更新日志

### v1.2.0
- ✅ 添加 API 余额查询功能
- ✅ 实现真正的多轮对话
- ✅ 支持消息历史传递
- ✅ 优化上下文管理
- ✅ 添加余额显示界面

## 未来计划

- [ ] 余额不足提醒
- [ ] 自动清理过长的对话历史
- [ ] 对话历史的导出功能
- [ ] 更智能的上下文管理
- [ ] 支持自定义系统提示词
