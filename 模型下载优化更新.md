# 模型下载优化更新

## 更新日期
2024-11-25

## 问题描述

用户在首次使用 RAG 功能时，嵌入模型下载失败，错误信息：

```
嵌入模型加载失败: TypeError: fetch failed
Error: read ECONNRESET
```

这是由于从 Hugging Face 下载模型时网络连接不稳定导致的。

## 解决方案

### 1. 添加自动重试机制

**文件**：`src/main/services/embeddingService.ts`

**改进**：
- 最多重试 3 次
- 递增等待时间（2秒、4秒、6秒）
- 显示重试进度
- 2分钟超时保护
- 下载进度回调

**代码示例**：
```typescript
const maxRetries = 3;
for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    // 尝试加载模型
    this.model = await this.transformers.pipeline('feature-extraction', this.modelName, {
      progress_callback: (progress: any) => {
        console.log(`下载进度: ${progress.file} - ${Math.round(progress.progress || 0)}%`);
      }
    });
    return; // 成功
  } catch (error) {
    // 重试逻辑
    if (attempt < maxRetries) {
      await new Promise(resolve => setTimeout(resolve, attempt * 2000));
    }
  }
}
```

### 2. 支持镜像源配置

**文件**：`src/main/services/embeddingService.ts`

**改进**：
- 支持通过环境变量配置镜像源
- 推荐使用 hf-mirror.com（中国大陆用户）
- 自动检测并应用配置

**配置方式**：
```env
HUGGINGFACE_MIRROR=https://hf-mirror.com
```

### 3. 支持代理配置

**文件**：`src/main/services/embeddingService.ts`

**改进**：
- 支持 HTTP/HTTPS 代理
- 自动读取环境变量
- 兼容标准代理配置

**配置方式**：
```env
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

### 4. 更新环境变量示例

**文件**：`.env.example`

**新增内容**：
```env
# Hugging Face 模型下载配置（可选）
# 如果下载模型时遇到网络问题，可以配置以下选项：

# 1. 使用镜像源（推荐用于中国大陆用户）
# HUGGINGFACE_MIRROR=https://hf-mirror.com

# 2. 使用代理
# HTTP_PROXY=http://127.0.0.1:7890
# HTTPS_PROXY=http://127.0.0.1:7890
```

## 新增工具

### 1. 配置镜像源脚本

**文件**：`配置镜像源.bat`

**功能**：
- 交互式配置镜像源
- 自动创建 .env 文件
- 支持自定义镜像源
- 检测现有配置

**使用方法**：
```bash
双击运行 "配置镜像源.bat"
```

### 2. 网络连接测试脚本

**文件**：`测试网络连接.bat`

**功能**：
- 测试 Hugging Face 直连
- 测试镜像源可用性
- 显示当前配置
- 提供配置建议

**使用方法**：
```bash
双击运行 "测试网络连接.bat"
```

## 新增文档

### 1. 模型下载问题解决方案

**文件**：`模型下载问题解决方案.md`

**内容**：
- 问题描述
- 4 种解决方案
- 详细配置步骤
- 常见问题解答
- 技术细节说明

### 2. RAG 功能使用指南

**文件**：`RAG功能使用指南.md`

**内容**：
- 快速开始指南
- 常见问题解答
- 性能优化建议
- 技术细节
- 故障排除

### 3. 故障排除指南

**文件**：`故障排除指南.md`

**内容**：
- 模型下载问题
- 应用启动问题
- 文档上传问题
- 检索问题
- 性能问题
- 预防性维护

## 技术改进

### 错误处理

**改进前**：
```typescript
try {
  this.model = await this.transformers.pipeline('feature-extraction', this.modelName);
} catch (error) {
  throw new Error(`嵌入模型加载失败: ${error.message}`);
}
```

**改进后**：
```typescript
const maxRetries = 3;
let lastError: any = null;

for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    // 带超时和进度的加载
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('模型加载超时')), 120000);
    });
    
    const modelPromise = this.transformers.pipeline('feature-extraction', this.modelName, {
      progress_callback: (progress: any) => {
        console.log(`下载进度: ${progress.file} - ${Math.round(progress.progress || 0)}%`);
      }
    });
    
    this.model = await Promise.race([modelPromise, timeoutPromise]);
    return; // 成功
  } catch (error: any) {
    lastError = error;
    if (attempt < maxRetries) {
      await new Promise(resolve => setTimeout(resolve, attempt * 2000));
    }
  }
}

throw new Error(`嵌入模型加载失败: ${lastError?.message || '未知错误'}`);
```

### 配置管理

**新增功能**：
```typescript
// 镜像源配置
const huggingfaceMirror = process.env.HUGGINGFACE_MIRROR;
if (huggingfaceMirror) {
  console.log(`使用 Hugging Face 镜像源: ${huggingfaceMirror}`);
  this.transformers.env.remoteHost = huggingfaceMirror;
}

// 代理配置
const httpProxy = process.env.HTTP_PROXY || process.env.http_proxy;
if (httpProxy) {
  console.log(`使用代理: ${httpProxy}`);
}
```

## 用户体验改进

### 1. 更友好的错误提示

**改进前**：
```
嵌入模型加载失败: TypeError: fetch failed
```

**改进后**：
```
开始加载嵌入模型: Xenova/all-MiniLM-L6-v2 (尝试 1/3)
首次加载需要下载模型（约 80MB），请耐心等待...
如果网络不稳定，系统会自动重试...
下载进度: model.onnx - 45%
```

### 2. 自动化配置工具

- 一键配置镜像源
- 自动检测网络状况
- 智能推荐配置方案

### 3. 完善的文档

- 分步骤指南
- 图文并茂（待添加）
- 常见问题解答
- 故障排除流程

## 测试验证

### 构建测试

```bash
npm run build
```

**结果**：✅ 构建成功，无错误

### 代码检查

```bash
getDiagnostics(['src/main/services/embeddingService.ts'])
```

**结果**：✅ 无诊断问题

## 使用指南

### 首次使用

1. **配置镜像源**（推荐）
   ```bash
   双击运行 "配置镜像源.bat"
   ```

2. **测试网络**
   ```bash
   双击运行 "测试网络连接.bat"
   ```

3. **启动应用**
   ```bash
   双击运行 "双击我运行.bat"
   ```

4. **上传文档**
   - 打开文档库
   - 点击上传按钮
   - 等待模型下载和文档处理

### 遇到问题时

1. 查看 `模型下载问题解决方案.md`
2. 运行 `测试网络连接.bat`
3. 尝试配置镜像源或代理
4. 查看 `故障排除指南.md`

## 后续计划

### 短期（1-2周）

- [ ] 添加模型下载进度条（UI）
- [ ] 支持离线模式（使用预下载的模型）
- [ ] 添加模型验证功能

### 中期（1个月）

- [ ] 支持多种嵌入模型选择
- [ ] 优化模型加载速度
- [ ] 添加模型管理界面

### 长期（3个月）

- [ ] 支持自定义模型
- [ ] 模型热更新
- [ ] 分布式模型缓存

## 相关文件

### 修改的文件
- `src/main/services/embeddingService.ts` - 核心改进
- `.env.example` - 配置示例

### 新增的文件
- `配置镜像源.bat` - 配置工具
- `测试网络连接.bat` - 测试工具
- `模型下载问题解决方案.md` - 解决方案文档
- `RAG功能使用指南.md` - 使用指南
- `故障排除指南.md` - 故障排除
- `模型下载优化更新.md` - 本文档

## 总结

本次更新主要解决了嵌入模型下载失败的问题，通过以下方式提升了用户体验：

1. **技术层面**
   - 自动重试机制
   - 镜像源支持
   - 代理配置
   - 超时保护
   - 进度显示

2. **工具层面**
   - 配置脚本
   - 测试脚本
   - 自动化工具

3. **文档层面**
   - 详细的解决方案
   - 完整的使用指南
   - 系统的故障排除

这些改进使得用户即使在网络不稳定的情况下，也能顺利完成模型下载和使用 RAG 功能。

## 反馈

如有问题或建议，请：
1. 查看相关文档
2. 提交 GitHub Issue
3. 参与社区讨论
